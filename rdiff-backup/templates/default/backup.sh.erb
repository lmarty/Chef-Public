#!/usr/bin/env bash
#
# backup script generated by chef for <%= node.fqdn %>
# DO NOT EDIT - manual edits WILL be lost
#

if [ -f <%= node['rdiff-backup']['cron']['lockfile'] %> ] ; then
  echo "lock file present; aborting backup" >&2
  exit 1
fi

touch <%= node['rdiff-backup']['cron']['lockfile'] %>

<% @clients.each do |c| 
if c['dirs'] != nil then %>

# <%= c['fqdn'] %>
echo "
starting backup of <%= c['fqdn'] %>
"
ssh <%= c['fqdn'] %> 'find <%= node['rdiff-backup']['etc_dir'] %>/pre.d -type f -exec {} \;'
rdiff-backup --print-statistics --remote-schema 'ssh -C %s "sudo /usr/bin/rdiff-backup --server --restrict-read-only /"' <% c['dirs'].each do |d,w| %> --include <%= d %> <% end %> --exclude / <%= c['fqdn'] %>::/ <%= node['rdiff-backup']['backup_dir'] %>/<%= c['fqdn'] %>
ssh <%= c['fqdn'] %> 'find <%= node['rdiff-backup']['etc_dir'] %>/post.d -type f -exec {} \;'
<% if node['rdiff-backup']['autotrim']['enable'] then %>
rdiff-backup --force --remove-older-than <%= node['rdiff-backup']['autotrim']['timespan'] %> <%= node['rdiff-backup']['backup_dir'] %>/<%= c['fqdn'] %>
<% end
end
end %>

rm <%= node['rdiff-backup']['cron']['lockfile'] %>
